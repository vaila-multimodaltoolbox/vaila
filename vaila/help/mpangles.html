<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MP Angles - MediaPipe Angle Calculation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; max-width: 1200px; }
    h1, h2, h3 { color: #2c3e50; }
    h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
    h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; margin-top: 30px; }
    h3 { color: #34495e; margin-top: 20px; }
    pre { background-color: #f4f4f4; padding: 15px; overflow: auto; border-left: 4px solid #3498db; }
    code { background-color: #f4f4f4; padding: 3px 6px; border-radius: 3px; }
    table { border-collapse: collapse; width: 100%; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #3498db; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .info-box { background-color: #e8f4f8; border-left: 4px solid #3498db; padding: 15px; margin: 20px 0; }
    .warning-box { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; }
    ul, ol { margin: 10px 0; padding-left: 30px; }
    li { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>MP Angles - MediaPipe Angle Calculation</h1>

  <div class="info-box">
    <strong>Module Information:</strong><br>
    Category: Utils | File: vaila/mpangles.py | Version: 0.0.3<br>
    Author: Paulo R. P. Santiago | Update: February 2026 | License: AGPL v3.0
  </div>

  <h2>Description</h2>
  <p>
    The <strong>MP Angles</strong> module calculates absolute and relative joint angles from MediaPipe landmark coordinates. It processes <strong>CSV files</strong> (or a <strong>Directory</strong> in batch), optionally with a matching video to generate skeleton overlay and angles. Outputs include angle CSVs, an annotated video (when video is used), and an HTML report with an angles table and a stick-figure sequence PNG.
  </p>

  <h3>Key Features</h3>
  <ul>
    <li><strong>Input:</strong> CSV or Directory only. For CSV, you select the corresponding video for overlay when running. For Directory, the module finds videos and matching CSVs by name (prefers <code>*_pixel_vaila.csv</code>).</li>
    <li><strong>Absolute Angles:</strong> Left side -180° to +180°, right side 0° to 360° in the video overlay. All segments: trunk, neck, thigh, shank, foot, upper arm, forearm, hand.</li>
    <li><strong>Relative Angles:</strong> Joint angles (shoulder, elbow, wrist, hip, knee, ankle, neck, trunk). Neck (relative) is shown at the top center of the video.</li>
    <li><strong>Smoothing (optional):</strong> Section “Smoothing (optional)” with a clear checkbox: “Apply Butterworth low-pass filter (smooth joint trajectories)”. Hint: “Use when data is noisy; leave unchecked for raw angles.” Cutoff (Hz), Order, and FPS are always editable.</li>
    <li><strong>HTML Report:</strong> Contains an <strong>Angles</strong> table (preview of relative angles CSV) and a <strong>Pose sequence (stick figures)</strong> PNG — no embedded video. For directory runs, <strong>batch_analysis_report.html</strong> lists all processed videos with links to reports and output videos.</li>
    <li><strong>Video overlay:</strong> Skeleton and angle values in corners; angle values at joints on the figure.</li>
  </ul>

  <h2>Supported Angles</h2>

  <h3>Relative (joint angles)</h3>
  <ul>
    <li>Neck, Trunk</li>
    <li>Shoulder, Elbow, Wrist (left and right)</li>
    <li>Hip, Knee, Ankle (left and right)</li>
  </ul>

  <h3>Absolute (segment angles)</h3>
  <ul>
    <li>Trunk, Neck</li>
    <li>Thigh, Shank, Foot (left and right)</li>
    <li>Upper arm, Forearm, Hand (left and right)</li>
  </ul>
  <p>Generated in both -180°..+180° and 0°..360° formats.</p>

  <h2>Usage</h2>

  <h3>GUI (recommended)</h3>
  <ol>
    <li>Launch the module.</li>
    <li><strong>Input:</strong> Choose <strong>CSV</strong> or <strong>Dir</strong> and browse to the file or folder.</li>
    <li><strong>Smoothing:</strong> Optionally check “Apply Butterworth low-pass filter...” and set Cutoff, Order, FPS (always editable).</li>
    <li>Click <strong>RUN ANALYSIS</strong>. If you selected a CSV, you will be asked to select the video for that CSV; then the overlay and report are generated. If you selected a directory, videos are processed in batch and the batch report is created there.</li>
  </ol>

  <h3>Command line</h3>
  <pre><code># Directory (batch): videos + matching CSVs → overlay and report for each
python -m vaila.mpangles -i /path/to/dir

# CSV only: angle CSVs only (no video, no report)
python -m vaila.mpangles -i /path/to/landmarks.csv

# CSV + video: overlay and report
python -m vaila.mpangles -i /path/to/landmarks.csv -v /path/to/video.mp4

# Everything together: CSV + video + Butterworth filter
python -m vaila.mpangles -i /path/to/landmarks.csv -v /path/to/video.mp4 --filter --cutoff 6.0 --order 4 --fps 30

# Directory with filter
python -m vaila.mpangles -i /path/to/dir --filter --cutoff 6.0 --order 4 --fps 30</code></pre>
  <p><strong>Arguments:</strong> <code>-i/--input</code> (CSV or directory), <code>-v/--video</code> (video path; use with CSV for overlay and report), <code>-o/--output</code> (optional; default: folder <code>angles_video_&lt;timestamp&gt;</code> next to the video), <code>--filter</code>, <code>--cutoff</code>, <code>--order</code>, <code>--fps</code>.</p>
  <p>With <strong>CSV + video</strong> (with or without <code>--filter</code>), output is written to that folder: the three angle CSVs, <code>angles_&lt;videoname&gt;.mp4</code>, the stick-figure PNG, and <code>analysis_report.html</code>.</p>

  <h2>Input Requirements</h2>

  <h3>CSV format</h3>
  <ul>
    <li><strong>First column:</strong> Frame index</li>
    <li><strong>Next columns:</strong> 33 landmarks × 2 coordinates = 66 columns (e.g. p1_x, p1_y, ..., p33_x, p33_y)</li>
    <li><strong>Total:</strong> At least 67 columns. Angle output files (e.g. *_rel.csv) are not valid inputs and are skipped in directory mode.</li>
  </ul>

  <div class="info-box">
    <strong>Preferred format:</strong> <code>*_pixel_vaila.csv</code> (vaila format). The module prefers this when multiple CSVs match the same video name.
  </div>

  <h2>Output Files</h2>

  <p>For each processed input:</p>
  <ol>
    <li><strong>*_rel.csv</strong> — Relative angles</li>
    <li><strong>*_abs_180.csv</strong> — Absolute angles (-180° to +180°)</li>
    <li><strong>*_abs_360.csv</strong> — Absolute angles (0° to 360°)</li>
  </ol>

  <p>When a video is used (CSV + video or directory batch):</p>
  <ul>
    <li><strong>angles_{videoname}.mp4</strong> — Annotated video with skeleton and angles</li>
    <li><strong>{basename}_stick_sequence.png</strong> — Colored stick-figure sequence (blue/red/gray segments, green joints, angle labels)</li>
    <li><strong>analysis_report.html</strong> — Report with angles table and stick figure PNG (no embedded video)</li>
  </ul>

  <p>For directory runs:</p>
  <ul>
    <li><strong>batch_analysis_report.html</strong> — In the selected directory, with links to each output folder, report, and video</li>
  </ul>

  <h2>Configuration</h2>

  <h3>Smoothing (optional)</h3>
  <ul>
    <li><strong>Checkbox:</strong> “Apply Butterworth low-pass filter (smooth joint trajectories)” — filter is applied only when checked.</li>
    <li><strong>Cutoff (Hz):</strong> Typically 6–10 Hz for human motion</li>
    <li><strong>Order:</strong> Typically 2 or 4</li>
    <li><strong>FPS:</strong> Must match the data/video frame rate</li>
  </ul>

  <h2>Troubleshooting</h2>

  <table>
    <tr><th>Issue</th><th>Solution</th></tr>
    <tr>
      <td>No CSV or videos in directory</td>
      <td>Ensure folder has videos and matching landmark CSVs (e.g. *_pixel_vaila.csv). Angle outputs are skipped.</td>
    </tr>
    <tr>
      <td>CSV has wrong number of columns</td>
      <td>Input must have at least 67 columns (frame + 66 coordinates). Angle CSVs are not valid inputs.</td>
    </tr>
    <tr>
      <td>Video not visible in file dialog</td>
      <td>Use “All files” or select the specific video format in the dialog when choosing the video for a CSV.</td>
    </tr>
    <tr>
      <td>Permission denied</td>
      <td>Check write permissions and disk space for the output directory.</td>
    </tr>
  </table>

  <h2>Requirements</h2>
  <ul>
    <li>Python 3.12.12+</li>
    <li>pandas, numpy, opencv-python, scipy, rich; tkinter (GUI)</li>
    <li>Optional: matplotlib (for stick figure sequence in report)</li>
  </ul>

  <h2>Integration</h2>
  <p>
    <strong>Input from:</strong> Markerless 2D Analysis (e.g. <code>*_pixel_vaila.csv</code>), any MediaPipe landmark CSV<br>
    <strong>Output to:</strong> Analysis tools, visualization, statistics (CSV and report)
  </p>

  <h2>Related Documentation</h2>
  <ul>
    <li><a href="../../docs/vaila_buttons/mp-angles-calculation.html">MP Angles Button Documentation</a></li>
    <li><a href="markerless_2d_analysis.html">Markerless 2D Analysis Help</a></li>
    <li><a href="../../docs/index.html">vailá Main Documentation</a></li>
  </ul>

  <hr>
  <p><small>Last Updated: February 2026 | Part of vailá - Multimodal Toolbox</small></p>
</body>
</html>
