# cutvideo.py

## üìã Module Information

- **Category:** Tools
- **File:** `vaila/cutvideo.py`
- **Version:** 0.0.9
- **Author:** Paulo Roberto Pereira Santiago
- **Email:** paulosantiago@usp.br
- **GitHub:** https://github.com/vaila-multimodaltoolbox/vaila
- **GUI Interface:** ‚úÖ Yes
- **License:** GNU General Public License v3.0

## üìñ Description

This script provides an interactive video cutting tool with scientific precision for research applications. It allows users to visually mark cut points in videos, save cut information, and generate precisely cut video segments while preserving original metadata with high accuracy.

### Key Features

- **Scientific Precision**: Uses `ffmpeg` to preserve exact frame rates (e.g., 59.94005994005994 fps) without rounding
- **Metadata Preservation**: Maintains original codec, frame rate, and video properties
- **Interactive Video Player**: Pygame-based player with frame-accurate navigation
- **Visual Cut Marking**: Mark start and end frames visually while playing video
- **Sync File Support**: Load cuts from synchronization files generated by `syncvid.py`
- **Batch Processing**: Apply same cuts to multiple videos in a directory
- **Cut Management**: Save, load, list, and remove cuts
- **Resizable Window**: Adjustable window size for different video resolutions

## üîß Main Functions

**Total functions found:** 18+

### Core Functions
- `play_video_with_cuts()` - Main interactive video player with cut marking
- `cut_video_with_ffmpeg()` - Precise video cutting using ffmpeg (preserves metadata)
- `cut_video_with_opencv()` - Fallback cutting method using OpenCV
- `get_precise_video_metadata()` - Extract precise video metadata using ffprobe
- `save_cuts()` - Generate cut video files
- `save_cuts_to_txt()` - Save cut information to text file

### File Management Functions
- `load_cuts_from_txt()` - Load existing cuts from text file
- `load_sync_file()` - Load cuts from sync file in directory
- `load_sync_file_from_dialog()` - Load sync file via dialog
- `load_cuts_or_sync()` - Auto-detect and load cuts or sync file

### Batch Processing Functions
- `batch_process_sync_videos()` - Process all videos according to sync file
- `batch_process_videos()` - Apply same cuts to multiple videos

### Utility Functions
- `get_video_path()` - File dialog for video selection
- `cleanup_resources()` - Resource cleanup
- `run_cutvideo()` - Main entry point

## üéÆ Interactive Controls

### Navigation
- **Space**: Play/Pause video
- **Right Arrow**: Next frame (when paused)
- **Left Arrow**: Previous frame (when paused)
- **Up Arrow**: Fast forward 60 frames
- **Down Arrow**: Rewind 60 frames
- **Mouse Click on Slider**: Jump to specific frame

### Cutting Operations
- **S**: Mark start frame of current cut
- **E**: Mark end frame of current cut (must be after start)
- **R**: Reset current cut (clear start marker)
- **DELETE**: Remove last cut from list
- **L**: List all marked cuts

### File Operations
- **F**: Load sync file (from Make Sync File tool)
- **ESC**: Save cuts to file and optionally generate videos

### Window Controls
- **Resize Window**: Drag window edges to resize
- **Help Button**: Click "Help" button for full control list

## üìä Scientific Precision Features

### Precise Frame Rate Preservation
- Uses `ffprobe` to extract exact frame rates as fractions (e.g., 1001/1000 = 1.001 fps)
- Converts fractions to high-precision floats (9 decimal places)
- Preserves non-integer frame rates like 59.94005994005994 fps

### Metadata Preservation
- **Codec Preservation**: Attempts to copy original codec without re-encoding
- **Frame Rate**: Maintains exact frame rate from source video
- **Resolution**: Preserves original video dimensions
- **Quality**: Uses `-c copy` when possible to avoid quality loss

### Fallback Mechanisms
1. **Primary**: `ffmpeg` with `-c copy` (no re-encoding, fastest, preserves all metadata)
2. **Secondary**: `ffmpeg` with re-encoding (if copy fails, preserves frame rate)
3. **Tertiary**: OpenCV fallback (if ffmpeg unavailable, uses float FPS)

## üìÅ Input/Output Files

### Input Files
- **Video Files**: `.mp4`, `.avi`, `.mov`, `.mkv` (any format supported by OpenCV/ffmpeg)
- **Cut Files**: `*_cuts.txt` - Text file with cut information
- **Sync Files**: `*.txt` - Synchronization files from `syncvid.py`

### Output Files
1. **Cut Information** (`*_cuts.txt`)
   - Text file listing all cuts
   - Format: `Cut N: Frame X to Frame Y`
   - Created automatically when cuts are saved

2. **Cut Videos** (`*_frame_X_to_Y.mp4`)
   - Individual video files for each cut
   - Preserves original codec and metadata when possible
   - Named with frame numbers for easy identification

3. **Batch Output Directory**
   - `vailacut_batch_TIMESTAMP/` - Regular batch processing
   - `vailacut_sync_TIMESTAMP/` - Sync file batch processing
   - Contains all cut videos from batch operation

## üöÄ Usage

### Basic Usage
```python
from vaila.cutvideo import run_cutvideo

# Launch interactive video cutting interface
run_cutvideo()
```

### Programmatic Usage
```python
from vaila.cutvideo import (
    get_precise_video_metadata,
    cut_video_with_ffmpeg,
    save_cuts_to_txt
)
from pathlib import Path

# Get precise metadata
video_path = Path("video.mp4")
metadata = get_precise_video_metadata(video_path)
print(f"FPS: {metadata['fps']:.9f}")  # High precision

# Cut video (frames 100 to 500)
output_path = Path("output_cut.mp4")
cut_video_with_ffmpeg(
    video_path,
    output_path,
    start_frame=100,
    end_frame=500,
    metadata=metadata
)

# Save cuts to file
cuts = [(100, 500), (1000, 1500)]
save_cuts_to_txt(video_path, cuts)
```

## üíª Requirements

- **Python**: 3.12.11+
- **OpenCV**: `opencv-python` or `opencv-contrib-python`
- **Pygame**: For interactive video player
- **ffmpeg/ffprobe**: Recommended for precise cutting (automatically detected)
- **Tkinter**: Usually included with Python

## ‚öôÔ∏è Technical Details

### Frame Rate Precision
The script uses `ffprobe` to extract frame rates as fraction strings (e.g., "30000/1001") and converts them to high-precision floats. This ensures that videos with non-standard frame rates (like 29.97002997002997 fps or 59.94005994005994 fps) maintain their exact frame rate in cut videos.

### Cutting Method
1. **Input Seeking**: Uses `-ss` before `-i` for faster seeking
2. **Frame Accuracy**: Calculates start time and duration with 6 decimal places
3. **Codec Copy**: Attempts `-c copy` first to avoid re-encoding
4. **Re-encoding Fallback**: If copy fails, re-encodes with high quality settings

### Sync File Format
Sync files contain one line per video:
```
video_file.mp4 new_name.mp4 initial_frame final_frame
```

Example:
```
test_video.mp4 cut1.mp4 100 500
test_video.mp4 cut2.mp4 1000 1500
```

## üî¨ Scientific Research Applications

This tool is designed for scientific research where precision is critical:

- **Biomechanics**: Frame-accurate video cutting for movement analysis
- **Motion Capture**: Precise synchronization with other data sources
- **Video Analysis**: Maintain exact frame rates for temporal analysis
- **Data Integrity**: Preserve all original video metadata

## üìù Notes

- **Frame Numbers**: All frame numbers are 0-indexed internally but displayed as 1-indexed to users
- **Cut Validation**: End frame must be after start frame
- **Video Formats**: Supports all formats readable by OpenCV/ffmpeg
- **Memory Usage**: Processes videos frame-by-frame to minimize memory usage
- **Platform Support**: Works on Windows, macOS, and Linux

## üêõ Troubleshooting

### ffmpeg Not Found
- Script will automatically fall back to OpenCV
- Install ffmpeg for best results: https://ffmpeg.org/download.html

### Video Won't Play
- Check video codec compatibility
- Try converting video to H.264 first
- On Linux, may need: `export LIBGL_ALWAYS_SOFTWARE=1`

### Cuts Not Accurate
- Ensure ffmpeg is installed for frame-accurate cutting
- Check that frame rate is correctly detected (see metadata output)
- Use frame-by-frame navigation (arrow keys) for precise marking

## üìö Related Tools

- **syncvid.py**: Create synchronization files for multiple videos
- **numberframes.py**: Analyze video metadata with scientific precision
- **resize_video.py**: Resize videos while preserving metadata

---

üìÖ **Last Updated:** January 2025  
üîó **Part of vail√° - Multimodal Toolbox**  
üåê [GitHub Repository](https://github.com/vaila-multimodaltoolbox/vaila)
